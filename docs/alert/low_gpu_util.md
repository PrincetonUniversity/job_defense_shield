# Low GPU Utilization

This alert identifies the users that are consuming the most GPU-hours with a low efficiency.

## Configuration File

Below is an example entry for `config.yaml`:

This configuration can be used for reports and sending emails:


```yaml
low-gpu-efficiency-1:
  cluster: della
  partitions:
    - gpu
  eff_thres_pct: 25         # percent
  absolute_thres_hours: 50  # gpu-hours
  eff_target_pct: 50        # percent
  email_file: "low_gpu_efficiency.txt"
  admin_emails:
    - admin@institution.edu
```

The parameters are explained below:

- `cluster`: Specify the cluster name as it appears in the Slurm database. One cluster name
per alert.

- `partitions`: Specify one or more Slurm partitions. The number of GPU-hours is summed over all partitions.

- `eff_thres_pct`: Efficiency threshold percentage. Users with a `eff_thres_pct` os less than or equal to this value will receive an email.

- `absolute_thres_hours`: A user must have allocated more than this number of GPU-hours to be considered to receive an email.

- `eff_target_pct`: The target value for GPU utilization that users should strive for. It is only used in emails. This value can be referenced as the tag `<TARGET>` in email messages (see `email/low_gpu_efficiencies.txt`).

- `email_file`: The file used as a email body. This file must be found in the `email-files-path` setting in `config.yaml`. Learn more about writing custom emails.

Below is a full set of parameters:

```yaml
low-gpu-efficiency-1:
  cluster: della
  partitions:
    - gpu
  eff_thres_pct: 25         # percent
  proportion_thres_pct: 2   # percent
  absolute_thres_hours: 50  # gpu-hours
  eff_target_pct: 50        # percent
  num_top_users: 15         # count
  min_run_time: 30          # minutes
  email_file: "low_gpu_efficiency.txt"
  admin_emails:
    - admin@institution.edu
```

- `num_top_users`: After sorting all users by GPU-hours, only consider the top `num_top_users` for all remaining calculations and emails. This is used to limit the number of users that receive emails and appear in reports.

- `min_run_time`: (Optional) The number of minutes that a job must have ran to be considered. This can be used to exclude test jobs and experimental jobs. Default: 0

- `proportion_thres_pct`: A user must being using this proportion of the total GPU-hours (as a percentage) in order to be sent an email. For example, setting this to 2 will excluded all users that are using less than 2% of the total GPU-hours. Default: 0

- `excluded_users`: (Optional) List of usernames to exclude from receiving emails. These users will still appear
in reports for system administrators when `--report` is used.

- `admin_emails`: (Optional) The emails sent to users will also be sent to these administator emails. This applies
when the `--email` option is used.

## Report

Here is an example of the report:

```
$ python job_defense_shield.py --low-gpu-efficiency

                    Low GPU Efficiencies                                      
------------------------------------------------------------
 User   GPU-Hours  Proportion(%)  GPU-Eff(%)  Jobs  AvgCores
------------------------------------------------------------
u76174    3791         20             19       58     1.2  
u64732    3201         17             15       43     1.0 
u13301    2281         12              9       35     8.0
------------------------------------------------------------
   Cluster: della
Partitions: gpu
     Start: Wed Mar 12, 2025 at 09:56 AM
       End: Wed Mar 19, 2025 at 09:56 AM
```

The table lists users from the most GPU-hours to the least. The GPU efficiency is
listed.

## How to Write the Email File

Below is the email message that is generated by the template in `email/low_gpu_efficiencies.txt`:

```
Hello Alan (u12345),

Over the last 7 days you have used the 3rd most GPU-hours on della (pli-c) but
your mean GPU efficiency is only 29%:

     User  Partition(s)  Jobs  GPU-hours GPU-rank Efficiency
    jg9945    pli-c       65     2345      3/53      29%    

A good target value for "Efficiency" is 75% and above. Please investigate the reason
for the low efficiency.

Replying to this automated email will open a support ticket with Research
Computing.
```

### Tags

The tags that can be used in the email message are:

- `<GREETING>`: The greeting that will be generated based on the choice of `greeting_method` in `config.yaml`. An example is "Hello Alan (aturing),".
- `<CLUSTER>`: The name of the cluster as defined in `config.yaml`.
- `<PARTITIONS>`: A comma-separated list of partitions as defined for the alert in `config.yaml`.
- `<TABLE>`: A table of jobs for the user.
- `<JOBSTATS>`: A line showing how to run the `jobstats` command on one of the jobs of the user. An example is `$ jobstats 1234567`.

## Usage

Generate a report of the top users are their GPU efficiencies:

```
$ python job_defense_shield.py --low-gpu-efficiency
```

Send emails to users with low GPU efficiencies over the past 7 days:

```
$ python job_defense_shield.py --low-gpu-efficiencies --email
```

## cron

It is recommended to run this alert with a time window of 7 days:

```bash
PY=/home/sysadmin/.conda/envs/jds-env/bin
JDS=/homem/sysadmin/bin/job_defense_shield
MYLOG=${JDS}/log

0 9 * * * ${PY}/python ${JDS}/job_defense_shield.py --low-gpu-efficiency --email > ${MYLOG}/low_gpu_efficiencies.log 2>&1
```
## Related Alerts

See [low CPU utilization](low_cpu_util.md)
