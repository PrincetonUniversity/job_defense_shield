# Serial Codes Allocating Multiple CPU-Cores

This alert finds jobs that are running serial codes while allocating multiple CPU-cores. A serial code can only use 1 CPU-core so the other allocated cores are wasted.

## Configuration File

Below is an example entry for `config.yaml`:

```yaml
serial-allocating-multiple-1:
  cluster: della
  partitions:
    - cpu
  min_run_time:          61  # minutes
  cpu_hours_threshold:  100  # cpu-hours
  lower_ratio:         0.85  # [0.0, 1.0]
  num_top_users:          5  # count
  email_file: "serial_allocating_multiple.txt"
  admin_emails:
    - admin@institution.edu
```

The parameters are explained below:

- `cluster`: Specify the cluster name as it appears in the Slurm database. One cluster name
per alert.

- `partitions`: Specify one or more Slurm partitions.

- `min_run_time`: (Optional) Minimum run time in minutes for a job to be included in the calculation. For example, if `min_run_time: 30` is used then jobs that ran for less than 30 minutes are ignored. Default: 0

- `cpu_hours_threshold`: (Required) A user must have apparently wasted this number of CPU-hours to be considered. Default: 0

- `lower_ratio`: (Required) This alert works by comparing the CPU efficiency of the job to 100% divided by the number of allocated CPU-cores. If the ratio of these two numbers of greater than or equal to `lower_ratio` then the job is assumed to be a serial code wasting CPU-cores. For instance, if the CPU efficieny of a job that allocates 8 CPU-cores is 12.4% and `lower_ratio` is 0.85 then this job would be included since 12.4% / (100% / 8) is greater than 0.85. Default: 0.85

- `num_top_users`: (Optional) Only consider the number of users equal to `num_top_users` as sorted by "wasted CPU-hours".

- `include_running_jobs`: (Optional) If `True` then jobs in a state of `RUNNING` will be included in the calculation. The Prometheus server must be queried for each running job, which can be an expensive operation. Default: False

- `nodelist`: (Optional) Only apply this alert to jobs that ran on the specified nodes. See [example](../nodelist.md).

- `excluded_users`: (Optional) List of users to exclude from receiving emails. These users will still appear
in reports for system administrators when `--report` is used.

- `email_file`: The text file to be used for the email message.

- `admin_emails`: (Optional) The emails sent to users will also be sent to these administator emails. This applies
when the `--email` option is used.

## Report for System Administrators

Below is a sample report:

```
$ python job_defense_shield.py --serial-allocating-multiple

                       Serial Jobs Allocating Multiple CPU-Cores                        
----------------------------------------------------------------------------------------
    User   CPU-Hours-Wasted AvgCores  Jobs                JobID                  Emails 
----------------------------------------------------------------------------------------
1  u74805        1248           8      36          62777629,62829596,62834509+    6 (33)
2  u31448         906          30       3          62887368,62887370,62887407     0     
3  u93676         783           3      20   62904738_0,62904738_1,62904738_10+    1 (10)
4  u16959         325          15       6          62893341,62896573,62912383+   14 (17)
5  u36725         164          12      11   62814801_11,62814801_8,62814801_9+    1 (10)
----------------------------------------------------------------------------------------
   Cluster: della
Partitions: cpu
     Start: Sun Mar 09, 2025 at 10:21 PM
       End: Sun Mar 16, 2025 at 10:21 PM
```


## Email Message to Users

Below is an example email to a user:

```
Hello Alan (u12345),

Below are your jobs that ran on della (cpu) in the past 7 days:

      JobID   Partition  CPU-Cores  CPU-Util  100%/CPU-cores  Hours
    62599800     cpu         4       24.8%        25.0%        48  
    62599800     cpu         4       24.9%        25.0%        48  
    62695534     cpu        12        8.3%         8.3%        24  
    62719003     cpu        12        8.3%         8.3%        24  

The CPU utilization (CPU-Util) of each job above is approximately equal to
100% divided by the number of allocated CPU-cores (100%/CPU-cores). This
suggests that you may be running a code that can only use 1 CPU-core. If this is
true then allocating more than 1 CPU-core is wasteful. A good target value for
CPU utilization is 90% and above.

If the code cannot run in parallel then please use the following Slurm
directives:

    #SBATCH --nodes=1
    #SBATCH --ntasks=1
    #SBATCH --cpus-per-task=1

Replying to this automated email will open a support ticket with Research
Computing.
```

### Placeholders

These placeholders can be used to generate custom emails:

- `<GREETING>`: The greeting generated by `greeting-method`.
- `<CLUSTER>`: The cluster specified for the alert (i.e., `cluster`).
- `<PARTITIONS>`: The partitions listed for the alert (i.e., `partitions`).
- `<CASE>`: The rank of the user.
- `<DAYS>`: Time window of the alert in days.
- `<CPU-HOURS>`: Total number of CPU-hours wasted if the code is in fact serial. This quantity is the elapsed time of the job multiplied by the number of allocated core minus one (summed over all jobs).
- `<NUM-JOBS>`: Total number of jobs with at least one idle GPU.
- `<NUM-NODES>`: Number of numbers wasted. To use this one must specify `cores_per_node` in the alert.
- `<TABLE>`: Table of job data.
- `<JOBSTATS>`: `jobstats` command for the first JobID (`$ jobstats 12345678`).

## Usage

Send emails to the offending users:

```
$ python job_defense_shield.py --serial-allocating-multiple --email
```

Check which users have received emails and how many:

```
$ python job_defense_shield.py --serial-allocating-multiple --check
```
